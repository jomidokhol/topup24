<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nagad Payment - Vercel topup</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;600;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans Bengali', sans-serif; }

        body {
            background-color: #f4f6f9;
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; padding-top: 20px;
        }

        .container { width: 100%; max-width: 400px; margin: 0 auto; padding-bottom: 20px; }

        .header-icons {
            display: flex; justify-content: space-between; padding: 10px 20px;
            background: white; border-radius: 8px; margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); align-items: center;
        }
        .header-icons span { color: #5f6368; cursor: pointer; font-size: 18px; }

        .logo-section { text-align: center; margin-bottom: 20px; }
        .logo-section img { width: 260px; }

        .white-box {
            background: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 10px;
            display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-weight: 600; color: #444;
        }
        .wallet-icon {
            width: 30px; height: 30px; margin-right: 15px; border: 1px solid #ddd;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #999;
        }

        .red-card {
            background-color: #cf1d23; color: white; padding: 20px;
            border-radius: 8px 8px 0 0; margin-top: 10px; position: relative;
        }

        .section-title { text-align: center; margin-bottom: 15px; font-size: 16px; font-weight: 600; }

        .input-group { margin-bottom: 20px; }
        .input-group input {
            width: 100%; padding: 12px; border-radius: 5px; border: none;
            font-size: 14px; outline: none;
        }

        .instructions { list-style: none; font-size: 13px; line-height: 1.6; }
        .instructions li { position: relative; padding-left: 15px; margin-bottom: 12px; }
        .instructions li::before { content: "•"; position: absolute; left: 0; font-weight: bold; }

        .highlight-yellow { color: #ffe600; font-weight: bold; }

        .copy-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
            color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;
            cursor: pointer; margin-left: 5px; display: inline-flex; align-items: center;
        }

        .verify-btn {
            width: 100%; background-color: #cf1d23; color: white; border: none;
            padding: 15px; font-size: 16px; font-weight: bold; border-radius: 8px;
            cursor: pointer; margin-top: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.3s;
        }
        .verify-btn:hover { background-color: #b0151b; }
        .verify-btn:disabled { background-color: #e57373; cursor: not-allowed; opacity: 0.7; }
    </style>
</head>
<body>

<div class="container">
    
    <div class="header-icons">
        <span onclick="goBack()">&#8592;</span>
        <div style="display: flex; gap: 15px;">
            <span>Vercel Top up</span>
            <span onclick="goBack()">&#10005;</span>
        </div>
    </div>

    <div class="logo-section">
        <img src="https://i.ibb.co.com/4Z8HgrQV/Nagad-Logo-horizontally-Pngsource-VGQEUYU1.png" alt="Nagad Logo">
    </div>

    <div class="white-box">
        <div class="wallet-icon">
            <img src="https://i.ibb.co.com/4Z8HgrQV/Nagad-Logo-horizontally-Pngsource-VGQEUYU1.png" alt="" style="width: 15px; opacity: 0.5;">
        </div>
        <span>Nagad pay</span>
    </div>

    <div class="white-box" id="amountDisplayBox">
        ৳ <span id="mainAmountDisplay">...</span>
    </div>

    <div class="red-card">
        <div class="section-title">ট্রানজেকশন আইডি দিন</div>

        <div class="input-group">
            <input type="text" id="trxID" placeholder="ট্রানজেকশন আইডি দিন">
        </div>

        <ul class="instructions">
            <li>*167# ডায়াল করে আপনার Nagad মোবাইল মেনুতে যান অথবা Nagad অ্যাপে যান।</li>
            <li>"<span class="highlight-yellow">Send Money</span>" -এ ক্লিক করুন।</li>
            <li>
                প্রাপক নম্বর হিসেবে এই নম্বরটি লিখুনঃ <span class="highlight-yellow" id="adminNumberDisplay">loading...</span>
                <button class="copy-btn" onclick="copyNumber()">Copy</button>
            </li>
            <li>টাকার পরিমাণঃ <span class="highlight-yellow" id="instructionAmountDisplay">...</span></li>
            <li>নিশ্চিত করতে এখন আপনার Nagad মোবাইল মেনু পিন লিখুন।</li>
            <li>সবকিছু ঠিক থাকলে, আপনি Nagad থেকে একটি নিশ্চিতকরণ বার্তা পাবেন।</li>
            <li>এখন উপরের বক্সে আপনার <span class="highlight-yellow">Transaction ID</span> দিন এবং নিচে <span class="highlight-yellow">VERIFY</span> বাটনে ক্লিক করুন।</li>
        </ul>
    </div>

    <button class="verify-btn" id="verifyBtn" onclick="verifyPayment()" disabled>অপেক্ষা করুন...</button>

</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDjAnhVln8V-qpXDQmLWY8OTo7Qot01UPY",
      authDomain: "topup24vercel.firebaseapp.com",
      projectId: "topup24vercel",
      storageBucket: "topup24vercel.firebasestorage.app",
      messagingSenderId: "1054942807566",
      appId: "1:1054942807566:web:953c23afdd81bf7d225e5f",
      measurementId: "G-G700C4YP6W"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let pendingOrder = JSON.parse(localStorage.getItem('pendingOrder'));
    let currentUser = null;

    // Check Auth State First
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            // Enable button only when user is ready
            const btn = document.getElementById('verifyBtn');
            btn.disabled = false;
            btn.innerText = "VERIFY";
        } else {
            window.location.href = 'login.html';
        }
    });

    window.onload = function() {
        if (!pendingOrder) {
            alert("কোন অর্ডার পাওয়া যায়নি।");
            window.location.href = 'index.html'; // Default to home
            return;
        }
        const formattedAmount = parseFloat(pendingOrder.totalPrice).toFixed(2);
        document.getElementById('mainAmountDisplay').innerText = formattedAmount;
        document.getElementById('instructionAmountDisplay').innerText = formattedAmount;
        document.getElementById('adminNumberDisplay').innerText = pendingOrder.paymentNumber;
    };

    function goBack() {
        if(pendingOrder && pendingOrder.orderType === 'add_money') {
            window.location.href = 'add-money.html';
        } else {
            window.location.href = 'topup.html';
        }
    }

    function copyNumber() {
        if(pendingOrder && pendingOrder.paymentNumber) {
            navigator.clipboard.writeText(pendingOrder.paymentNumber).then(() => {
                alert('নম্বরটি কপি করা হয়েছে: ' + pendingOrder.paymentNumber);
            });
        }
    }

    async function verifyPayment() {
        if (!currentUser) {
            alert("ব্যবহারকারী শনাক্ত করা যাচ্ছে না।");
            return;
        }

        const trxID = document.getElementById('trxID').value.trim();
        const btn = document.getElementById('verifyBtn');

        if (!trxID) {
            alert("অনুগ্রহ করে ট্রানজেকশন আইডি দিন।");
            return;
        }

        btn.disabled = true;
        btn.innerText = "যাচাইকরণ চলছে...";

        // CASE 1: ADD MONEY REQUEST
        if (pendingOrder.orderType === 'add_money') {
            const requestData = {
                userId: currentUser.uid,
                amount: parseFloat(pendingOrder.totalPrice),
                paymentMethod: pendingOrder.paymentMethodName,
                adminNumber: pendingOrder.paymentNumber,
                userPaymentNumber: "Manual Input",
                transactionId: trxID,
                status: 'Pending',
                date: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('moneyRequests').add(requestData)
            .then(() => {
                alert("আপনার অ্যাড মানি রিকোয়েস্ট সফল হয়েছে!");
                localStorage.removeItem('pendingOrder');
                window.location.href = 'wallet.html'; // Redirect to wallet for Add Money
            })
            .catch((error) => {
                alert("রিকোয়েস্ট করতে সমস্যা হয়েছে: " + error.message);
                btn.disabled = false;
                btn.innerText = "VERIFY";
            });

        } 
        // CASE 2: GAME TOPUP ORDER (With Stock Management)
        else {
            let orderData = {
                userId: currentUser.uid, 
                game: pendingOrder.gameName,
                package: pendingOrder.packageAmount,
                quantity: pendingOrder.quantity,
                price: parseFloat(pendingOrder.totalPrice),
                playerId: pendingOrder.playerId,
                paymentMethod: pendingOrder.paymentMethodName,
                adminNumber: pendingOrder.paymentNumber,
                userPaymentNumber: "Manual Input",
                transactionId: trxID,
                status: 'Pending',
                date: firebase.firestore.FieldValue.serverTimestamp()
            };

            const gameRef = db.collection('games').doc(pendingOrder.gameId);

            try {
                await db.runTransaction(async (transaction) => {
                    const gameDoc = await transaction.get(gameRef);
                    if (!gameDoc.exists) throw "এই প্রোডাক্টটি এখন আর পাওয়া যাচ্ছে না।";

                    const gameData = gameDoc.data();
                    const packages = gameData.packages || [];
                    const packageIndex = packages.findIndex(p => p.amount === pendingOrder.packageAmount && p.price === pendingOrder.packagePrice);
                    
                    if (packageIndex === -1) throw "এই প্যাকেজটি এখন আর পাওয়া যাচ্ছে না।";
                    
                    const currentStock = parseInt(packages[packageIndex].stock);
                    if (isNaN(currentStock) || currentStock < pendingOrder.quantity) throw "দুঃখিত! স্টকে পর্যাপ্ত পরিমাণ নেই।";

                    // Deduct Stock
                    packages[packageIndex].stock = currentStock - pendingOrder.quantity;
                    transaction.update(gameRef, { packages: packages });
                    
                    // Create Order
                    transaction.set(db.collection('orders').doc(), orderData);
                });

                // Success
                localStorage.setItem('lastOrder', JSON.stringify(orderData));
                localStorage.removeItem('pendingOrder');
                window.location.href = 'order-confirmation.html';

            } catch (error) {
                console.error(error);
                alert("সমস্যা হয়েছে: " + (error.message || error));
                btn.disabled = false;
                btn.innerText = "VERIFY";
            }
        }
    }
</script>

</body>
</html>