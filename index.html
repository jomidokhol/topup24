<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="google" content="notranslate">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Vercel Topup BD - Home</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
/* Roboto font for Footer */
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
/* Core CSS variables */
:root {
--primary-purple: #7B61FF;
--light-purple: #E9E7FF;
--background-color: #F5F5F7; 
--card-bg-color: #ffffff;
--primary-text-color: #1D1D1F;
--secondary-text-color: #86868B;
--accent-green: #34C759;
--accent-red: #FF3B30;
--border-radius-large: 20px;
--border-radius-medium: 14px;
--soft-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
--nav-shadow: 0 -5px 20px rgba(0,0,0,0.05);
--font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
--skeleton-bg: #e0e0e0;
--skeleton-card-bg: #ffffff;
}
body.dark-mode {
    --background-color: #000000; 
    --card-bg-color: #1C1C1E; 
    --primary-text-color: #F5F5F7;
    --secondary-text-color: #8E8E93;
    --light-purple: #2C2C2E;
    --soft-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    --nav-shadow: 0 -5px 20px rgba(255,255,255,0.05);
    --skeleton-bg: #333;
    --skeleton-card-bg: #1C1C1E;
}
* { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent;
}
body {
    font-family: var(--font-family);
    background-color: var(--background-color);
    color: var(--primary-text-color);
    min-height: 100vh;
    transition: background-color 0.3s, color 0.3s;
    -webkit-font-smoothing: antialiased; 
    padding-bottom: 90px; /* Space for bottom nav */
}

/* App Container */
.app-container { 
    width: 100%; 
    max-width: 480px; 
    margin: auto; 
    background-color: var(--background-color);
    min-height: 100vh;
    position: relative;
    padding: 20px;
    padding-top: 80px; /* UPDATED: Added space for fixed header */
    overflow-x: hidden;
}

/* Header - UPDATED for Fixed Position */
.header { 
    display: flex; justify-content: space-between; align-items: center; 
    padding: 10px 20px; margin-bottom: 0px; 
    position: fixed; 
    width: 100%; 
    max-width: 480px; 
    left: 50%; 
    transform: translateX(-50%); 
    top: 0; 
    margin-left: 0; 
    margin-right: 0; 
    margin-top: 0;
    z-index: 999; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    background-color: rgba(255, 255, 255, 0.6); 
    border-bottom: 1px solid rgba(0,0,0,0.05);
}
body.dark-mode .header { background-color: rgba(0, 0, 0, 0.6); border-bottom: 1px solid rgba(255,255,255,0.05); }
.header-brand { display: flex; align-items: center; gap: 12px; overflow: hidden; }
.header-logo { width: 42px; height: 42px; border-radius: 12px; object-fit: cover; background-color: transparent; }
.header-title { font-size: clamp(16px, 5vw, 20px); font-weight: 800; letter-spacing: -0.5px; color: var(--primary-text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.header-right-icons { display: flex; align-items: center; gap: 15px; flex-shrink: 0; }
.profile-wrapper { position: relative; display: flex; align-items: center; }
.header .profile-avatar { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 2px solid var(--card-bg-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.status-dot { position: absolute; bottom: 2px; right: 0; width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--card-bg-color); background-color: var(--secondary-text-color); z-index: 10; }
.status-dot.online { background-color: #34C759; box-shadow: 0 0 5px rgba(52, 199, 89, 0.5); }
.status-dot.offline { background-color: #FF3B30; }
#headerWalletDisplay { display: none; align-items: center; gap: 8px; background-color: var(--light-purple); padding: 6px 12px; border-radius: 20px; white-space: nowrap; cursor: pointer; transition: transform 0.2s; }
#headerWalletDisplay:active { transform: scale(0.95); }
#headerWalletDisplay i { color: var(--primary-purple); }
#headerWalletBalance { font-size: clamp(12px, 4vw, 14px); font-weight: 700; color: var(--primary-text-color); }
.marquee-wrapper { background-color: var(--card-bg-color); padding: 10px 0; border-radius: var(--border-radius-medium); margin-bottom: 25px; box-shadow: var(--soft-shadow); overflow: hidden; position: relative; white-space: nowrap; }
.marquee-content { display: inline-block; font-size: 14px; font-weight: 500; color: var(--primary-text-color); padding-left: 100%; animation: marquee 15s linear infinite; }
.marquee-separator { margin: 0 10px; color: var(--accent-red); font-weight: 800; font-size: 16px; vertical-align: middle; }
@keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
.slider-container { width: 100%; height: 180px; margin-bottom: 30px; border-radius: var(--border-radius-large); overflow: hidden; position: relative; box-shadow: var(--soft-shadow); }
.slider { display: flex; height: 100%; transition: transform 0.5s ease-in-out; cursor: grab; }
.slider:active { cursor: grabbing; }
.slide { min-width: 100%; height: 100%; }
.slide img { width: 100%; height: 100%; object-fit: fill; display: block; pointer-events: none; }
.slider-dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; z-index: 10; }
.slider-dot { width: 6px; height: 6px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); transition: all 0.3s; }
.slider-dot.active { background-color: var(--primary-purple); width: 18px; border-radius: 4px; }
.category-section { margin-bottom: 30px; }
.section-title { font-size: 19px; font-weight: 700; margin: 0 0 20px 0; letter-spacing: -0.5px; text-align: center; }
.game-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 18px; padding-bottom: 10px;}
.game-card { background: var(--card-bg-color); border-radius: var(--border-radius-large); text-align: center; cursor: pointer; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: var(--soft-shadow); overflow: hidden; display: flex; flex-direction: column; border: 1px solid rgba(0,0,0,0.04); position: relative; }
body.dark-mode .game-card { border: 1px solid rgba(255,255,255,0.08); }
.game-card:active { transform: scale(0.96); }
.game-card .icon-wrapper { width: 100%; height: 160px; margin: 0 auto; background-color: var(--card-bg-color); display: flex; align-items: center; justify-content: center; padding: 10px; }
.game-card img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
.game-card .game-info-container { padding: 12px; background-color: var(--card-bg-color); flex-grow: 1; display: flex; flex-direction: column; justify-content: center; border-top: 1px solid rgba(0,0,0,0.03); }
.game-card .game-name { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
.card-badge { position: absolute; top: 0; right: 0; background-color: transparent; color: inherit; font-size: 16px; font-weight: 700; padding: 4px 10px; min-width: 30px; height: auto; display: flex; align-items: center; justify-content: center; z-index: 5; overflow: hidden; white-space: nowrap; border-radius: 0 0 0 15px; text-shadow: 0 2px 5px rgba(0,0,0,0.15); }
.card-badge::after { content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); transform: skewX(-25deg); animation: glassReflect 2.5s infinite linear; filter: blur(3px); }
@keyframes glassReflect { 0% { left: -150%; } 50% { left: 200%; } 100% { left: 200%; } }
.unavailable-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); display: none; justify-content: center; align-items: center; z-index: 10; }
body.dark-mode .unavailable-overlay { background-color: rgba(28, 28, 30, 0.7); }
.unavailable-overlay img { width: 70%; max-width: 100px; }
.game-card.disabled { cursor: not-allowed; opacity: 0.7; pointer-events: none; }
.game-card.disabled .unavailable-overlay { display: flex; }
.event-section-wrapper { position: relative; margin-bottom: 30px; margin-top: 25px; }
.event-content-box { border: 2px solid var(--primary-purple); border-radius: var(--border-radius-large); padding: 20px; padding-top: 45px; background: linear-gradient(45deg, var(--light-purple), transparent); box-shadow: 0 0 15px 3px rgba(123, 97, 255, 0.5); animation: pulse-glow 2.5s infinite alternate; display: flex; justify-content: center; }
@keyframes pulse-glow { from { box-shadow: 0 0 15px 3px rgba(123, 97, 255, 0.4); } to { box-shadow: 0 0 25px 8px rgba(123, 97, 255, 0.6); } }
.event-header-tab { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); background-color: var(--background-color); padding: 0 20px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
.event-timer { background-color: #1D1D1F; color: var(--accent-green); font-family: 'Courier New', Courier, monospace; padding: 6px 15px; border-radius: 20px; font-size: 14px; font-weight: 700; letter-spacing: 1px; border: 2px solid var(--card-bg-color); box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 5px; white-space: nowrap; }
body.dark-mode .event-header-tab { background-color: var(--background-color); }
body.dark-mode .event-timer { background-color: #2C2C2E; }
.bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; height: 80px; display: flex; justify-content: space-between; align-items: center; background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 0 20px; box-shadow: var(--nav-shadow); z-index: 1000; border-top: 1px solid rgba(0,0,0,0.05); border-radius: 20px 20px 0 0; }
body.dark-mode .bottom-nav { background-color: rgba(28, 28, 30, 0.9); border-color: rgba(255, 255, 255, 0.05); }
.nav-item { cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--secondary-text-color); position: relative; width: 60px; transition: color 0.3s; }
.nav-item i { font-size: 22px; margin-bottom: 6px; transition: transform 0.2s; }
.nav-item span { font-size: 11px; font-weight: 600; }
.nav-item.active { color: var(--primary-purple); }
.nav-item-center { position: relative; top: -25px; }
.nav-item-center .icon-bg { width: 60px; height: 60px; background: var(--primary-purple); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(123, 97, 255, 0.5); border: 6px solid var(--background-color); transition: transform 0.2s; }
.nav-item-center .icon-bg i { color: white; font-size: 24px; margin: 0; }
/* পরিবর্তন ৩ শুরু: চ্যাট মডাল এনিমেশন CSS */
.modal { display: none; position: fixed; z-index: 1002; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(5px); justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
.modal.show { opacity: 1; visibility: visible; }
.modal-content { background-color: var(--card-bg-color); padding: 25px; border-radius: var(--border-radius-large); width: 90%; max-width: 400px; box-shadow: var(--soft-shadow); text-align: center; transform: translateY(20px); transition: transform 0.3s ease; }
.modal.show .modal-content { transform: translateY(0); }
/* পরিবর্তন ৩ শেষ */
.modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); }
body.dark-mode .modal-header { border-color: rgba(255,255,255,0.05); }
.close-btn { color: #8E8E93; font-size: 28px; font-weight: bold; cursor: pointer; }
#popupImage { width: 100%; max-height: 220px; object-fit: cover; border-radius: var(--border-radius-medium); margin-top: 15px; display: none; }
.popup-btn { display: inline-block; margin-top: 15px; padding: 10px 20px; background-color: var(--primary-purple); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 14px; }
.footer { font-family: 'Roboto', sans-serif; padding: 30px 20px 20px 20px; margin-top: 50px; position: relative; margin-left: -20px; margin-right: -20px; transition: all 0.3s; }
.footer-container { max-width: 600px; margin: 0 auto; }
.footer { background-color: #ffffff; border-top: 1px solid rgba(0,0,0,0.05); color: #333; }
.footer h3 { font-size: 18px; font-weight: 700; margin-bottom: 15px; margin-top: 30px; text-transform: uppercase; letter-spacing: 1px; color: var(--primary-purple); }
.footer h3:first-child { margin-top: 0; }
.footer p { font-size: 14px; line-height: 1.6; margin-bottom: 5px; color: #555; }
.footer .brand-name { font-weight: bold; font-size: 14px; margin-bottom: 15px; display: block; color: #1D1D1F; }
.play-store-btn { display: inline-block; background-color: #000; border: 1px solid #333; border-radius: 5px; padding: 5px 10px; margin-top: 5px; width: 150px; cursor: pointer; transition: 0.3s; overflow: hidden; }
.play-store-btn img { width: 100%; display: block; }
.support-box { background: #F5F5F7; border: 1px solid rgba(0, 0, 0, 0.05); border-left: 4px solid var(--primary-purple); border-radius: 8px; padding: 15px; margin-bottom: 15px; display: flex; align-items: center; cursor: pointer; transition: all 0.3s ease; text-decoration: none; }
.support-box .icon { font-size: 28px; padding-right: 15px; color: var(--primary-purple); }
.support-box .divider { width: 1px; height: 35px; background: rgba(0,0,0,0.1); margin-right: 15px; }
.support-box .text-content { display: flex; flex-direction: column; }
.support-box .time-text { font-size: 11px; color: var(--accent-green); text-transform: uppercase; font-weight: 600; margin-bottom: 2px; }
.support-box .support-text { font-size: 16px; font-weight: 700; color: #1D1D1F; }
.footer-copyright { margin-top: 40px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); text-align: center; font-size: 12px; color: #888; }
.footer-copyright .copyright-brand-highlight { color: var(--primary-purple); font-weight: 600; }
#termsContainer { background: transparent !important; padding: 0 0 20px 0 !important; border-bottom: 1px solid rgba(0,0,0,0.1); margin-bottom: 30px !important; }
#termsTitle { color: var(--primary-purple) !important; font-size: 18px !important; font-weight: 700; margin-bottom: 10px; }
#termsText { color: inherit !important; opacity: 1 !important; font-size: 14px !important; line-height: 1.6; }
body.dark-mode .footer { background: linear-gradient(180deg, #1a0b2e 0%, #0d001a 100%); color: #ffffff; border-top: 3px solid #00e5ff; box-shadow: 0 -5px 20px rgba(0, 229, 255, 0.4), inset 0 10px 20px rgba(0, 0, 0, 0.5); }
body.dark-mode .footer::before { content: ''; position: absolute; top: -3px; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, #ff00ff, #00e5ff, #ff00ff); background-size: 200% 200%; animation: rgbFlow 3s linear infinite; z-index: 10; }
@keyframes rgbFlow { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
body.dark-mode .footer h3 { color: #00e5ff; text-shadow: 0 0 10px rgba(0, 229, 255, 0.5); }
body.dark-mode .footer p { color: #d1d1d1; }
body.dark-mode .footer .brand-name { color: #ff00ff; text-shadow: 0 0 5px rgba(255, 0, 255, 0.5); }
body.dark-mode .play-store-btn { border-color: #333; }
body.dark-mode .play-store-btn:hover { border-color: #00e5ff; box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); }
body.dark-mode .support-box { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(0, 229, 255, 0.2); border-left: 4px solid #6a0dad; }
body.dark-mode .support-box:hover { background: rgba(0, 229, 255, 0.05); border-color: #00e5ff; border-left: 4px solid #ff00ff; box-shadow: 0 0 20px rgba(0, 229, 255, 0.2); transform: scale(1.02); }
body.dark-mode .support-box .icon { color: #ffffff; }
body.dark-mode .support-box:hover .icon { color: #00e5ff; text-shadow: 0 0 10px #00e5ff; }
body.dark-mode .support-box .divider { background: linear-gradient(to bottom, transparent, #00e5ff, transparent); }
body.dark-mode .support-box .time-text { color: #00e5ff; }
body.dark-mode .support-box .support-text { color: #fff; }
body.dark-mode .footer-copyright { border-top: 1px solid rgba(255, 255, 255, 0.1); }
body.dark-mode .footer-copyright .copyright-brand-highlight { color: #00e5ff; }
body.dark-mode #termsContainer { border-bottom: 1px solid rgba(255,255,255,0.1); }
body.dark-mode #termsTitle { color: #00e5ff !important; }
.gift-card-container { background: transparent !important; box-shadow: none !important; border: none !important; display: flex; flex-direction: column; overflow: visible; }
.gift-card-content { width: 100%; min-height: 280px; background-color: var(--card-bg-color); border-radius: 15px; overflow: hidden; box-shadow: var(--soft-shadow); display: flex; flex-direction: column; position: relative; flex-grow: 1; }
.gc-top { color: white; position: relative; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; background: linear-gradient(135deg, #4285F4, #EA4335, #FBBC05, #34A853); background-size: 200% 200%; text-align: center; }
.gc-hanger { width: 6rem; height: 1.5rem; background-color: var(--card-bg-color); border-radius: 10px; position: absolute; top: 1.5rem; left: 50%; transform: translateX(-50%); }
.gc-hanger::before { content: ''; width: 2.5rem; height: 1.25rem; background-color: var(--card-bg-color); border-radius: 15px 15px 0 0; position: absolute; top: -0.75rem; left: 50%; transform: translateX(-50%); }
.gc-title { font-family: 'Inter', sans-serif; font-size: clamp(1.2rem, 4vw, 1.5rem); font-weight: 700; margin: 0; margin-top: 2.5rem; line-height: 1.2; }
.gc-subtitle { font-family: 'Inter', sans-serif; font-size: clamp(0.65rem, 2.5vw, 0.75rem); margin-top: 0.25rem; font-weight: 400; }
.gc-bottom { background-color: var(--card-bg-color); height: 45%; min-height: 110px; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-top: -20px; border-top-left-radius: 25px; border-top-right-radius: 25px; padding: 10px; }
.gc-play-logo-img { max-width: 60%; max-height: 50px; height: auto; object-fit: contain; margin-bottom: 5px; }
.gc-brand-name { position: absolute; bottom: 10px; right: 15px; color: var(--secondary-text-color); font-size: clamp(0.7rem, 3vw, 0.8rem); font-weight: 600; }
.support-fab { position: fixed; bottom: 130px; right: 20px; width: 56px; height: 56px; background-color: var(--primary-purple); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 8px 20px rgba(123, 97, 255, 0.4); z-index: 1001; }
.support-fab:active { transform: scale(0.9); }
/* পরিবর্তন ১ শুরু: চ্যাট নোটিফিকেশন CSS */
.notification-badge {
    position: absolute;
    top: 0;
    right: 0;
    width: 12px;
    height: 12px;
    background-color: var(--accent-red);
    border-radius: 50%;
    border: 2px solid var(--card-bg-color);
    display: none; /* ডিফল্টভাবে হাইড থাকবে */
}
/* পরিবর্তন ১ শেষ */
.chat-popover { position: absolute; right: 70px; top: 50%; transform: translateY(-50%); background: var(--card-bg-color); color: var(--primary-text-color); padding: 8px 12px; border-radius: 8px; box-shadow: var(--soft-shadow); white-space: nowrap; font-size: 13px; font-weight: 600; opacity: 0; visibility: hidden; transition: all 0.3s; pointer-events: none; max-width: 150px; overflow: hidden; text-overflow: ellipsis; }
.chat-popover::after { content: ''; position: absolute; top: 50%; right: -6px; margin-top: -6px; border-width: 6px; border-style: solid; border-color: transparent transparent transparent var(--card-bg-color); }
.chat-popover.show { opacity: 1; visibility: visible; right: 75px;  }
#supportModal .modal-content { display: flex; flex-direction: column; height: 75vh; }
.support-chat-body { flex-grow: 1; overflow-y: auto; padding: 15px 0; }
.support-chat-footer { display: flex; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 15px; }
body.dark-mode .support-chat-footer { border-color: rgba(255,255,255,0.05); }
#supportMessageInput { flex-grow: 1; border: none; background: var(--background-color); padding: 12px 15px; border-radius: 20px; color: var(--primary-text-color); font-size: 15px; margin-right: 10px;}
#supportMessageInput:focus { outline: none; }
#sendMessageBtn { background: var(--primary-purple); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(123, 97, 255, 0.3); }
.message { padding: 10px 16px; border-radius: 18px; margin-bottom: 8px; max-width: 80%; word-wrap: break-word; font-size: 14px; line-height: 1.4; }
.message.user { background-color: var(--primary-purple); color: white; align-self: flex-end; border-bottom-right-radius: 4px; margin-left: auto; }
.message.admin { background-color: var(--background-color); color: var(--primary-text-color); align-self: flex-start; border-bottom-left-radius: 4px; }
.message-container { display: flex; flex-direction: column; }
.skeleton { background-color: var(--skeleton-bg); position: relative; overflow: hidden; }
.skeleton::before { content: ''; position: absolute; top: 0; left: -150%; height: 100%; width: 150%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); animation: skeleton-wave 1.5s infinite; }
body.dark-mode .skeleton::before { background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.08), transparent); }
@keyframes skeleton-wave { 0% { left: -150%; } 100% { left: 150%; } }
#skeleton-loader .header { background: transparent; border: none; backdrop-filter: none; position: static; transform: none; left: auto; padding: 10px 0; }
.skeleton-logo { width: 42px; height: 42px; border-radius: 12px; }
.skeleton-title { width: 120px; height: 24px; border-radius: 8px; }
.skeleton-wallet { width: 80px; height: 30px; border-radius: 20px; }
.skeleton-avatar { width: 38px; height: 38px; border-radius: 50%; }
.skeleton-marquee { height: 40px; border-radius: var(--border-radius-medium); margin-bottom: 25px; background-color: var(--skeleton-card-bg); }
.skeleton-slider { height: 180px; border-radius: var(--border-radius-large); margin-bottom: 30px; }
.skeleton-section-title { height: 28px; width: 200px; margin: 0 auto 20px auto; border-radius: 8px; }
.skeleton-game-card { border-radius: var(--border-radius-large); background-color: var(--skeleton-card-bg); overflow: hidden; }
.skeleton-game-image { height: 160px; }
.skeleton-game-title { height: 48px; }

/* পরিবর্তন ২ শুরু: Toast Notification CSS */
.toast-notification {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(20, 20, 20, 0.9);
    color: white;
    padding: 12px 20px;
    border-radius: var(--border-radius-medium);
    box-shadow: var(--soft-shadow);
    z-index: 9999;
    font-size: 14px;
    font-weight: 500;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
    transform: translate(-50%, 20px);
}
.toast-notification.show {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, 0);
}
.toast-notification.error {
    background-color: var(--accent-red);
}
.toast-notification.success {
     background-color: var(--accent-green);
}
/* পরিবর্তন ২ শেষ */

</style>
</head>
<body>

<div class="app-container">
    
    <div id="skeleton-loader">
        <div class="header"> <div class="header-brand"> <div class="skeleton skeleton-logo"></div> <div class="skeleton skeleton-title"></div> </div> <div class="header-right-icons"> <div class="skeleton skeleton-wallet"></div> <div class="skeleton skeleton-avatar"></div> </div> </div>
        <div class="skeleton skeleton-marquee"></div>
        <div class="skeleton skeleton-slider"></div>
        <div class="category-section"> <div class="skeleton skeleton-section-title"></div> <div class="game-grid"> <div class="skeleton-game-card"> <div class="skeleton skeleton-game-image"></div> <div class="skeleton skeleton-game-title"></div> </div> <div class="skeleton-game-card"> <div class="skeleton skeleton-game-image"></div> <div class="skeleton skeleton-game-title"></div> </div> <div class="skeleton-game-card"> <div class="skeleton skeleton-game-image"></div> <div class="skeleton skeleton-game-title"></div> </div> <div class="skeleton-game-card"> <div class="skeleton skeleton-game-image"></div> <div class="skeleton skeleton-game-title"></div> </div> </div> </div>
    </div>
    
    <div id="main-content" style="display: none;">
        <header class="header"> <div class="header-brand"> <img src="https://i.ibb.co/74CkxSP/avatar.png" alt="Logo" class="header-logo" id="headerAppLogo"> <h1 class="header-title" id="headerAppName">Vercel Top Up</h1> </div> <div class="header-right-icons"> <div id="headerWalletDisplay" onclick="checkAuthAndGo('add-money.html')"> <i class="fa-solid fa-wallet"></i> <span id="headerWalletBalance">৳ 0.00</span> </div> <div class="profile-wrapper"> <i id="headerGuestIcon" class="fa-solid fa-circle-user" style="font-size: 38px; color: var(--secondary-text-color); cursor: pointer; display: block;" onclick="window.location.href='login.html'"></i> <img id="headerProfileAvatar" src="https://i.ibb.co/74CkxSP/avatar.png" alt="Avatar" class="profile-avatar" onclick="window.location.href='profile.html'" style="display: none;"> <span id="headerStatusDot" class="status-dot offline"></span> </div> </div> </header>
        <div class="marquee-wrapper"> <div class="marquee-content" id="headerMarquee"> আমাদের শপে আপনাকে স্বাগতম! সবচেয়ে কম দামে গেম টপ-আপ করুন। </div> </div>
        <div class="slider-container"> <div class="slider"></div> <div class="slider-dots"></div> </div>
        <div id="eventSectionContainer"></div>
        <div id="homeCategoriesContainer"></div>
        <footer class="footer"> <div class="footer-container"> <div id="termsContainer" style="display: none;"> <h3 id="termsTitle"></h3> <p id="termsText" style="white-space: pre-wrap;"></p> </div> <h3>STAY CONNECTED</h3> <span class="brand-name" id="footerBrandName">VERCEL TOP UP</span> <p id="footerAddress">Lalpur Road # 17, Natore, Rajshahi</p> <h3>OUR MOBILE APP</h3> <p>Download our official app</p> <a id="playStoreLink" href="#" target="_blank" class="play-store-btn"> <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg" alt="Get it on Google Play"> </a> <h3>SUPPORT CENTER</h3> <a href="#" id="whatsappBtn" class="support-box" target="_blank"> <div class="icon"><i class="fab fa-whatsapp"></i></div> <div class="divider"></div> <div class="text-content"> <span class="time-text" id="whatsappStatus">Status: Offline</span> <span class="support-text">WhatsApp Live Support</span> </div> </a> <a href="#" id="telegramBtn" class="support-box" target="_blank"> <div class="icon"><i class="fab fa-telegram-plane"></i></div> <div class="divider"></div> <div class="text-content"> <span class="time-text" id="telegramStatus">Status: Offline</span> <span class="support-text">Telegram Live Support</span> </div> </a> </div> <div class="footer-copyright" id="footerCopyright"> &copy; <span id="copyrightYear">2025</span> <span id="footerCopyrightBrand" class="copyright-brand-highlight">Vercel Top Up</span>. All Rights Reserved. </div> </footer>
    </div>

    <nav class="bottom-nav"> <div class="nav-item active" onclick="window.location.href='index.html'"> <i class="fa-solid fa-house"></i> <span>হোম</span> </div> <div class="nav-item" onclick="checkAuthAndGo('wallet.html')"> <i class="fa-solid fa-wallet"></i> <span>ওয়ালেট</span> </div> <div class="nav-item nav-item-center" onclick="checkAuthAndGo('add-money.html')"> <div class="icon-bg"><i class="fa-solid fa-plus"></i></div> <span>অ্যাড</span> </div> <div class="nav-item" onclick="checkAuthAndGo('orders.html')"> <i class="fa-solid fa-receipt"></i> <span>অর্ডার</span> </div> <div class="nav-item" onclick="checkAuthAndGo('profile.html')"> <i class="fa-regular fa-user"></i> <span>প্রোফাইল</span> </div> </nav>
    
    <div class="support-fab" id="supportBtn">
        <i class="fa-solid fa-headset"></i>
        <!-- পরিবর্তন ১ শুরু: চ্যাট নোটিফিকেশনের জন্য badge এবং popover যুক্ত করা -->
        <span class="chat-popover" id="chatPopover">কোন সমস্যা ?</span>
        <span class="notification-badge" id="chatNotificationBadge"></span>
        <!-- পরিবর্তন ১ শেষ -->
    </div>
</div>

<div id="dynamicPopup" class="modal"> <div class="modal-content"> <div class="modal-header"> <h2 id="popupTitle"></h2> <span class="close-btn" id="popupCloseBtn">&times;</span> </div> <img id="popupImage" src="" alt="Popup Image"> <p id="popupMessage" style="margin-top:20px; color:var(--secondary-text-color);"></p> <a id="popupActionButton" class="popup-btn" style="display: none;" href="#" target="_blank">Tap Here</a> </div> </div>
<div id="supportModal" class="modal"> <div class="modal-content"> <div class="modal-header"> <h2>সাপোর্ট চ্যাট</h2> <span class="close-btn" id="supportCloseBtn">&times;</span> </div> <div class="support-chat-body" id="supportChatBody"></div> <div class="support-chat-footer"> <input type="text" id="supportMessageInput" placeholder="আপনার মেসেজ লিখুন..."> <button id="sendMessageBtn"><i class="fa-solid fa-paper-plane"></i></button> </div> </div> </div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCZrkWD_5YQW0P-3SYhAzSE4pbCyTqvYu8",
      authDomain: "topupshopnur.firebaseapp.com",
      projectId: "topupshopnur",
      storageBucket: "topupshopnur.firebasestorage.app",
      messagingSenderId: "25262245834",
      appId: "1:25262245834:web:5a867f0516b120bfbcb133",
      measurementId: "G-QR5PYZDCG8"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let eventTimerInterval = null;
    let userData = {}; // Store user data including last chat open time

    const slider = document.querySelector('.slider');
    const dotsContainer = document.querySelector('.slider-dots');
    let currentSlide = 0;
    let slideInterval;
    let startX, moveX, isDragging = false;

    if (localStorage.getItem('theme') === 'dark-mode') {
        document.body.classList.add('dark-mode');
    }

    // পরিবর্তন ২ শুরু: Toast Notification ফাংশন
    function showToast(message, type = 'success') {
        const existingToast = document.querySelector('.toast-notification');
        if (existingToast) {
            existingToast.remove();
        }
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }
    // পরিবর্তন ২ শেষ

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('headerGuestIcon').style.display = 'none';
            document.getElementById('headerProfileAvatar').style.display = 'block';
            document.getElementById('headerWalletDisplay').style.display = 'flex';
            if (user.photoURL) {
                document.getElementById('headerProfileAvatar').src = user.photoURL;
            }
            db.collection('users').doc(user.uid).onSnapshot(doc => {
                if (doc.exists) {
                    userData = doc.data(); // Store user data
                    const finalPhoto = userData.photoURL || user.photoURL || "https://i.ibb.co/74CkxSP/avatar.png";
                    document.getElementById('headerProfileAvatar').src = finalPhoto;
                    document.getElementById('headerWalletBalance').innerText = `৳ ${parseFloat(userData.walletBalance || 0).toFixed(2)}`;
                    initSupportNotifications(); // User data is loaded, now init notifications
                }
            });
        } else {
            currentUser = null;
            userData = {};
            document.getElementById('headerGuestIcon').style.display = 'block';
            document.getElementById('headerProfileAvatar').style.display = 'none';
            document.getElementById('headerWalletDisplay').style.display = 'none';
        }
    });

    function checkAuthAndGo(page) {
        if (currentUser) {
            window.location.href = page;
        } else {
            window.location.href = 'login.html';
        }
    }

    async function initHome() {
        loadBranding();
        loadGames();
        loadSlider();
        initMarquee();
        initOnlineStatus();
        initPopup();
        loadTerms();
        initEvent();
        loadFooterDynamicData();
    }
    
    // ... (The rest of the functions like loadBranding, loadGames, etc. remain unchanged) ...

    async function loadBranding() { try { const doc = await db.collection('settings').doc('branding').get(); if (doc.exists) { const { appName, profileIconUrl } = doc.data(); if (appName) { document.getElementById('headerAppName').innerText = appName; document.getElementById('footerBrandName').innerText = appName.toUpperCase(); document.getElementById('footerCopyrightBrand').innerText = appName; } if (profileIconUrl) document.getElementById('headerAppLogo').src = profileIconUrl; } } catch (e) { console.error(e); } document.getElementById('copyrightYear').innerText = new Date().getFullYear(); }
    async function loadGames() { try { const snapshot = await db.collection('games').where('status', 'in', ['active', 'unavailable']).get(); const games = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderGames(games); } catch (e) { console.error(e); document.getElementById('skeleton-loader').style.display = 'none'; document.getElementById('main-content').style.display = 'block'; } }
    function renderGames(games) { const homeContainer = document.getElementById('homeCategoriesContainer'); const eventContainer = document.getElementById('eventSectionContainer'); homeContainer.innerHTML = ''; eventContainer.innerHTML = ''; const groupedGames = {}; games.forEach(game => { const category = game.category || "জনপ্রিয় গেমসমূহ"; if (!groupedGames[category]) groupedGames[category] = []; groupedGames[category].push(game); }); const sortedCategories = Object.keys(groupedGames).sort((a, b) => { if (a === 'Event') return -1; return 0; }); sortedCategories.forEach(category => { const sortedGames = groupedGames[category].sort((a, b) => (a.rank || 999) - (b.rank || 999)); const gridDiv = document.createElement('div'); gridDiv.className = 'game-grid'; sortedGames.forEach(game => { const card = document.createElement('div'); const badgeHtml = game.badgeText ? `<span class="card-badge">${game.badgeText}</span>` : ''; const unavailableOverlay = `<div class="unavailable-overlay"><img src="https://i.postimg.cc/66S03X9x/1000020217-removebg-preview.png"></div>`; if (category === "Gift Card’s") { card.className = 'game-card gift-card-container'; if (game.status === 'unavailable') card.classList.add('disabled'); card.innerHTML = ` ${unavailableOverlay} ${badgeHtml} <div class="gift-card-content"> <div class="gc-top"> <div class="gc-hanger"></div> <h1 class="gc-title">${game.name}</h1> <p class="gc-subtitle">Redeem for apps, games & more</p> </div> <div class="gc-bottom"> <img class="gc-play-logo-img" src="${game.logo}" alt="${game.name} Logo"> <span class="gc-brand-name">${game.name}</span> </div> </div> `; } else { card.className = 'game-card'; if (game.status === 'unavailable') card.classList.add('disabled'); card.innerHTML = `${unavailableOverlay} ${badgeHtml} <div class="icon-wrapper"><img src="${game.logo}" alt="${game.name}"></div> <div class="game-info-container"><div class="game-name">${game.name}</div></div>`; } card.onclick = () => { if (game.status !== 'unavailable') { localStorage.setItem('selectedGame', JSON.stringify(game)); window.location.href = 'topup.html'; } }; gridDiv.appendChild(card); }); if (category === 'Event') { eventContainer.innerHTML = ` <h2 class="section-title" id="eventHeaderTitle">Event</h2> <div class="event-section-wrapper"> <div class="event-header-tab"> <div class="event-timer">End in <span id="eventCountdown">00:00:00</span></div> </div> <div class="event-content-box"></div> </div>`; eventContainer.querySelector('.event-content-box').appendChild(gridDiv); } else { const sectionDiv = document.createElement('div'); sectionDiv.className = 'category-section'; sectionDiv.innerHTML = `<h2 class="section-title">${category}</h2>`; sectionDiv.appendChild(gridDiv); homeContainer.appendChild(sectionDiv); } }); document.getElementById('skeleton-loader').style.display = 'none'; document.getElementById('main-content').style.display = 'block'; }
    function updateSliderPosition() { if (!slider) return; slider.style.transform = `translateX(-${currentSlide * 100}%)`; updateDots(); }
    function createDots(count) { dotsContainer.innerHTML = ''; for (let i = 0; i < count; i++) { const dot = document.createElement('div'); dot.className = 'slider-dot'; if (i === 0) dot.classList.add('active'); dotsContainer.appendChild(dot); } }
    function updateDots() { const dots = document.querySelectorAll('.slider-dot'); const totalSlides = dots.length; if (totalSlides === 0) return; dots.forEach(dot => dot.classList.remove('active')); let activeIndex = currentSlide - 1; if (currentSlide === 0) activeIndex = totalSlides - 1; if (currentSlide === totalSlides + 1) activeIndex = 0; if (dots[activeIndex]) dots[activeIndex].classList.add('active'); }
    function nextSlide() { const totalSlidesWithClones = slider.children.length; if (totalSlidesWithClones <= 1) return; currentSlide++; slider.style.transition = 'transform 0.5s ease-in-out'; updateSliderPosition(); }
    function prevSlide() { const totalSlidesWithClones = slider.children.length; if (totalSlidesWithClones <= 1) return; currentSlide--; slider.style.transition = 'transform 0.5s ease-in-out'; updateSliderPosition(); }
    async function loadSlider() { try { const doc = await db.collection('settings').doc('slider').get(); slider.innerHTML = ''; if (doc.exists && doc.data().imageUrls) { const imageUrls = doc.data().imageUrls.filter(url => url); if (imageUrls.length === 0) return; imageUrls.forEach(url => { const slideDiv = document.createElement('div'); slideDiv.className = 'slide'; slideDiv.innerHTML = `<img src="${url}" alt="Promo Banner">`; slider.appendChild(slideDiv); }); createDots(imageUrls.length); if (imageUrls.length > 1) { const firstClone = slider.firstElementChild.cloneNode(true); const lastClone = slider.lastElementChild.cloneNode(true); slider.appendChild(firstClone); slider.insertBefore(lastClone, slider.firstElementChild); slider.addEventListener('transitionend', () => { const totalSlidesWithClones = slider.children.length; if (currentSlide >= totalSlidesWithClones - 1) { currentSlide = 1; slider.style.transition = 'none'; updateSliderPosition(); setTimeout(() => { slider.style.transition = 'transform 0.5s ease-in-out'; }); } else if (currentSlide <= 0) { currentSlide = totalSlidesWithClones - 2; slider.style.transition = 'none'; updateSliderPosition(); setTimeout(() => { slider.style.transition = 'transform 0.5s ease-in-out'; }); } }); currentSlide = 1; slider.style.transition = 'none'; updateSliderPosition(); setTimeout(() => { slider.style.transition = 'transform 0.5s ease-in-out'; }); slider.addEventListener('touchstart', (e) => { clearInterval(slideInterval); startX = e.touches[0].clientX; isDragging = true; }); slider.addEventListener('touchmove', (e) => { if (!isDragging) return; moveX = e.touches[0].clientX; }); slider.addEventListener('touchend', () => { isDragging = false; if (!startX || !moveX) return; const diff = startX - moveX; if (diff > 50) nextSlide(); else if (diff < -50) prevSlide(); startX = null; moveX = null; slideInterval = setInterval(nextSlide, 3000); }); } else { currentSlide = 0; updateSliderPosition(); } } } catch (error) { console.error("Error loading slider images:", error); } finally { clearInterval(slideInterval); if (slider.children.length > 1) slideInterval = setInterval(nextSlide, 3000); } }
    function initMarquee() { db.collection('settings').doc('notice').onSnapshot(doc => { if (doc.exists && doc.data().text) { let text = doc.data().text; const separator = '<span class="marquee-separator">|</span>'; text = text.replace(/([।\.])/g, '$1 ' + separator + ' '); document.getElementById('headerMarquee').innerHTML = text; } }); }
    function initOnlineStatus() { db.collection('settings').doc('onlineStatus').onSnapshot(doc => { const statusDot = document.getElementById('headerStatusDot'); if (doc.exists && doc.data().isOnline) { statusDot.classList.remove('offline'); statusDot.classList.add('online'); } else { statusDot.classList.remove('online'); statusDot.classList.add('offline'); } }); }
    function initPopup() { db.collection('settings').doc('popup').onSnapshot(doc => { if (doc.exists && doc.data().isActive && !sessionStorage.getItem('popupViewed')) { const data = doc.data(); document.getElementById('popupTitle').textContent = data.title || ''; document.getElementById('popupMessage').textContent = data.message || ''; if(data.imageUrl) { document.getElementById('popupImage').src = data.imageUrl; document.getElementById('popupImage').style.display = 'block'; } const btn = document.getElementById('popupActionButton'); if(data.buttonLink) { btn.href = data.buttonLink; btn.innerText = data.buttonText || 'Tap Here'; btn.style.display = 'inline-block'; } document.getElementById('dynamicPopup').style.display = 'flex'; } }); document.getElementById('popupCloseBtn').onclick = () => { document.getElementById('dynamicPopup').style.display = 'none'; sessionStorage.setItem('popupViewed', 'true'); }; }
    function initEvent() { db.collection('settings').doc('event').onSnapshot(doc => { const eventContainer = document.getElementById('eventSectionContainer'); if (eventTimerInterval) clearInterval(eventTimerInterval); if (doc.exists && doc.data().isActive) { const eventData = doc.data(); eventContainer.style.display = 'block'; const titleElement = document.getElementById('eventHeaderTitle'); if (titleElement && eventData.title) { titleElement.innerText = eventData.title; } const endTime = eventData.endDate ? eventData.endDate.toDate() : null; const timerEl = document.getElementById('eventCountdown'); if (!endTime || !timerEl) { if(timerEl) timerEl.parentElement.innerHTML = "No End Date"; return; } eventTimerInterval = setInterval(() => { const now = new Date().getTime(); const distance = endTime - now; if (distance < 0) { clearInterval(eventTimerInterval); timerEl.parentElement.innerHTML = "EXPIRED"; const eventCards = document.querySelectorAll('#eventSectionContainer .game-card'); eventCards.forEach(card => { card.classList.add('disabled'); card.onclick = null; }); return; } const days = Math.floor(distance / (1000 * 60 * 60 * 24)); const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)); const seconds = Math.floor((distance % (1000 * 60)) / 1000); const f = (n) => n < 10 ? '0' + n : n; const daysStr = days > 0 ? `${f(days)}d ` : ''; timerEl.innerHTML = daysStr + `${f(hours)}:${f(minutes)}:${f(seconds)}`; }, 1000); } else { eventContainer.style.display = 'none'; } }); }
    async function loadTerms() { const doc = await db.collection('settings').doc('terms').get(); if(doc.exists && doc.data().text) { document.getElementById('termsTitle').innerText = doc.data().title || 'Terms & Conditions'; document.getElementById('termsText').innerText = doc.data().text; document.getElementById('termsContainer').style.display = 'block'; } }
    function loadFooterDynamicData() { db.collection('settings').doc('contact').onSnapshot(doc => { if(doc.exists) { const data = doc.data(); if(data.address) document.getElementById('footerAddress').innerText = data.address; const waBtn = document.getElementById('whatsappBtn'); if(data.whatsappLink) waBtn.href = data.whatsappLink; if(data.whatsappStatus) document.getElementById('whatsappStatus').innerText = "Status: " + data.whatsappStatus; const tgBtn = document.getElementById('telegramBtn'); if(data.telegramLink) tgBtn.href = data.telegramLink; if(data.telegramStatus) document.getElementById('telegramStatus').innerText = "Status: " + data.telegramStatus; } }); db.collection('settings').doc('app').onSnapshot(doc => { if(doc.exists) { const data = doc.data(); const playBtn = document.getElementById('playStoreLink'); if(data.playStoreLink) { playBtn.href = data.playStoreLink; } else { playBtn.removeAttribute('href'); } } }); }
    
    // ===============================================
    // Support Chat Functionality
    // ===============================================
    
    function formatMessage(text) {
        let formattedText = text;
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        formattedText = formattedText.replace(urlRegex, '<a href="$1" target="_blank" style="color: inherit;">$1</a>');
        return formattedText;
    }

    const supportModal = document.getElementById('supportModal');
    const supportBtn = document.getElementById('supportBtn');
    const supportCloseBtn = document.getElementById('supportCloseBtn');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const supportMessageInput = document.getElementById('supportMessageInput');
    const supportChatBody = document.getElementById('supportChatBody');
    const chatPopover = document.getElementById('chatPopover');
    const chatNotificationBadge = document.getElementById('chatNotificationBadge');
    let unsubscribeSupportChat;
    let unsubscribeNotifications;

    setInterval(() => {
        if (!chatPopover.classList.contains('show')) {
            chatPopover.classList.add('show');
            setTimeout(() => {
                chatPopover.classList.remove('show');
            }, 3000);
        }
    }, 15000);

    // পরিবর্তন ১ শুরু: সাপোর্ট চ্যাট নোটিফিকেশন ফাংশন
    function initSupportNotifications() {
        if (!currentUser || unsubscribeNotifications) return;

        unsubscribeNotifications = db.collection('supportMessages')
            .where('userId', '==', currentUser.uid)
            .where('sender', '==', 'admin')
            .orderBy('timestamp', 'desc')
            .limit(1)
            .onSnapshot(snapshot => {
                if (!snapshot.empty) {
                    const lastAdminMessage = snapshot.docs[0].data();
                    const lastSeenTimestamp = userData.lastSupportChatOpenTimestamp || { seconds: 0 };
                    
                    if (lastAdminMessage.timestamp && lastAdminMessage.timestamp.seconds > lastSeenTimestamp.seconds) {
                        chatNotificationBadge.style.display = 'block';
                        chatPopover.textContent = lastAdminMessage.message;
                        chatPopover.classList.add('show');
                        setTimeout(() => chatPopover.classList.remove('show'), 5000); // নতুন মেসেজ ৫ সেকেন্ড দেখাবে
                    } else {
                        chatNotificationBadge.style.display = 'none';
                        chatPopover.textContent = 'কোন সমস্যা ?';
                    }
                }
            });
    }
    // পরিবর্তন ১ শেষ

    supportBtn.onclick = () => {
        if (!currentUser) {
            window.location.href = 'login.html';
            return;
        }

        // পরিবর্তন ৩ শুরু: মডাল ওপেন এনিমেশন
        supportModal.style.display = "flex";
        setTimeout(() => supportModal.classList.add('show'), 10);
        // পরিবর্তন ৩ শেষ

        if (unsubscribeSupportChat) unsubscribeSupportChat();

        unsubscribeSupportChat = db.collection('supportMessages').where('userId', '==', currentUser.uid).orderBy('timestamp', 'asc').onSnapshot(snapshot => {
            supportChatBody.innerHTML = '';
            if (snapshot.empty) {
                supportChatBody.innerHTML = '<p style="text-align:center; color: var(--secondary-text-color);">আপনার প্রশ্ন এখানে লিখুন</p>';
            }
            snapshot.forEach(doc => {
                const messageData = doc.data();
                const messageDiv = document.createElement('div');
                const container = document.createElement('div');
                container.className = 'message-container';
                messageDiv.className = `message ${messageData.sender}`;
                messageDiv.innerHTML = formatMessage(messageData.message);
                container.appendChild(messageDiv);
                supportChatBody.appendChild(container);
            });
            supportChatBody.scrollTop = supportChatBody.scrollHeight;
        });

        // পরিবর্তন ১: চ্যাট খোলার সাথে সাথে নোটিফিকেশন হাইড করা এবং সময় আপডেট করা
        chatNotificationBadge.style.display = 'none';
        chatPopover.textContent = 'কোন সমস্যা ?';
        db.collection('users').doc(currentUser.uid).update({
            lastSupportChatOpenTimestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    };

    supportCloseBtn.onclick = () => {
        // পরিবর্তন ৩: মডাল ক্লোজ এনিমেশন
        supportModal.classList.remove('show');
        supportModal.addEventListener('transitionend', function handler() {
            supportModal.style.display = "none";
            supportModal.removeEventListener('transitionend', handler);
        });
        // পরিবর্তন ৩ শেষ

        if (unsubscribeSupportChat) {
            unsubscribeSupportChat();
            unsubscribeSupportChat = null;
        }
    };

    sendMessageBtn.onclick = async () => {
        const message = supportMessageInput.value.trim();
        if (message === '') return;
        supportMessageInput.value = '';

        await db.collection('supportMessages').add({
            userId: currentUser.uid,
            userName: currentUser.displayName || currentUser.email,
            message: message,
            sender: 'user',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    };

    function makeDraggable(element, container) { let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0; let moved = false; element.onmousedown = dragMouseDown; element.ontouchstart = dragMouseDown; function dragMouseDown(e) { e = e || window.event; pos3 = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX; pos4 = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY; document.onmouseup = closeDragElement; document.onmousemove = elementDrag; document.ontouchend = closeDragElement; document.ontouchmove = elementDrag; element.style.cursor = 'grabbing'; moved = false; } function elementDrag(e) { moved = true; e = e || window.event; if (e.type === 'touchmove') { e.preventDefault(); } const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX; const currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY; pos1 = pos3 - currentX; pos2 = pos4 - currentY; pos3 = currentX; pos4 = currentY; let newTop = element.offsetTop - pos2; let newLeft = element.offsetLeft - pos1; const maxTop = container.offsetHeight - element.offsetHeight; const maxLeft = container.offsetWidth - element.offsetWidth; newTop = Math.max(0, Math.min(newTop, maxTop)); newLeft = Math.max(0, Math.min(newLeft, maxLeft)); element.style.top = newTop + "px"; element.style.left = newLeft + "px"; element.style.bottom = 'auto'; element.style.right = 'auto'; } function closeDragElement() { document.onmouseup = null; document.onmousemove = null; document.ontouchend = null; document.ontouchmove = null; element.style.cursor = 'pointer'; } element.addEventListener('click', function(e) { if (moved) { e.preventDefault(); e.stopPropagation(); } }, true); }
    makeDraggable(document.getElementById('supportBtn'), document.querySelector('.app-container'));
    initHome();
</script>
</body>
</html>
